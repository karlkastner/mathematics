% Sa 19. Dez 19:46:32 CET 2015
% Karl Kastner, Berlin
%
%% sum of squares of cos of inner angles of triangle
%
% a,b,c : vertex coordinates
% 
function [f, g, H] = ddot(a,b,c)
	a = a.';
	b = b.';
	c = c.';
	% side vectors from points
	ab  = a-b;
	ac  = a-c;
	% squared side lengths
	ab2 = ab(:,1).^2 + ab(:,2).^2;
	ac2 = ac(:,1).^2 + ac(:,2).^2;
	% side length
	ab1 = sqrt(ab2);
	ac1 = sqrt(ac2);
	abac = ab(:,1).*ac(:,1) + ab(:,2).*ac(:,2);

	% cos of angle
	cosa = abac./sqrt(ab2.*ac2);

	if (0)
		% objective function
		%f = (ab(:,1).*ac(:,1) + ab(:,2).*ac(:,2)).^2./(ab2.*ac2) - cos(pi/3)^2;
		%f = (ab(:,1).*ac(:,2) + ab(:,2).*ac(:,2)).^2./(ab2.*ac2) - cos(pi/3)^2;
		cosalim = cos(pi/2);
		f = max(0,cosalim - abac./sqrt(ab2.*ac2)).^2;
		%f = max(0,(ab(:,1).*ac(:,2) + ab(:,2).*ac(:,2))./(ab2.*ac2) - cosalim).^2;
	else
		f = cosa;
	end

	if (nargout > 1)
		% first derivative vector
		a=a.';
		b=b.';
		c=c.';
		g = gradient_([a(1,:).',b(1,:).',c(1,:).'],[a(2,:).',b(2,:).',c(2,:).']);
	%	g = gradient(ab,ac,ab2,ac2).';
		% second derivative vector
		if (nargout > 2)
			H = hessian_([a(1,:).',b(1,:).',c(1,:).'],[a(2,:).',b(2,:).',c(2,:).']);
			%H = hessian(ab,ac,ab2,ac2);
		end
	end
end % function ddot

function g = gradient_(X,Y)
	g = [
%((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3)))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(1./2), ...
	      - (X(:,2) - 2.*X(:,1) + X(:,3))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(1./2) - (((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)), ...
		((2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - (X(:,1) - X(:,3))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(1./2), ...
		((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - (X(:,1) - X(:,2))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(1./2), ...
- (Y(:,2) - 2.*Y(:,1) + Y(:,3))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(1./2) - (((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)), ...
((2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - (Y(:,1) - Y(:,3))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(1./2), ...
((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - (Y(:,1) - Y(:,2))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(1./2)];
end

function g = gradient(ab,ac,ab2,ac2)
	g = g000(ab,ac,ab2,ac2);
if (0)

	% parametrise boundary points
	% regress quaratic coefficients for parametric representation of boundary points
	A = [1 -1 1;
             0 0  1;
             1 1  1];
	b = [rvec(xl);
             rvec(xc);
             rvec(xr)];
	cx = A \ b;
	b = [rvec(yl);
             rvec(yc);
             rvec(yr)];
	cy = A \ b;	
	% determine which points are on the boundary (3-bit)
% note, this is not E!!!, but already permuted
	pflag    = zeros(np,1);
	bnd  = flat(edge(bnd));
	pflag(bnd) = 1;
	eflag = zeros(size(elem));
	for idx=1:3
		eflag(:,idx) = pflag(elem(:,idx));
	end
	eflag = e*[4;2;1];
	% compute gradient (with respect to s on the boundary)
	switch (eflag)
	case {0}
		g = g000();
	case {1}
		g = g100();
	case {2}
		g = g010();
	case {3}
		g = g001();
	case {4}
		g = g110();
	case {5}
		g = g101();
	case {6}
		g = g011();
	case {7}
		g = g111();
	end % switch case
	% transform gradient of s to gradient in x and y
	% dy = (c1y + 2 c2y s)ds|_0 = c1y ds
	dx = cx(2,:)*ds;
	dy = cy(2,:)*ds;
	% write back
end % if 0
end % gradient

function g = g000(ab,ac,ab2,ac2)
	abac = ab.*ac;
	den  = abac(:,1) + abac(:,2);
	nom  = sqrt(ab2.*ac2);
	if (~issym(ab))
	g = bsxfun(@times, -0.5*(den./nom.^1.5), ...
           [	-(ab(:,1) + ac(:,1)) + den.*(ab(:,1)./ab2 + ac(:,1)./ac2), ...
	        -(ab(:,2) + ac(:,2)) + den.*(ab(:,2)./ab2 + ac(:,2)./ac2), ...
	        -(den.*ab(:,1))./ab2 + ac(:,1) , ...
		-(den.*ab(:,2))./ab2 + ac(:,2) , ...
	        -(den.*ac(:,1))./ac2 + ab(:,1) , ...
	        -(den.*ac(:,2))./ac2 + ab(:,2) ] );

%	g = bsxfun(@times, -2*(den./nom2), ...
%           [	-(ab(:,1) + ac(:,1)) + den.*(ab(:,1)./ab2 + ac(:,1)./ac2), ...
%	        -(ab(:,2) + ac(:,2)) + den.*(ab(:,2)./ab2 + ac(:,2)./ac2), ...
%	        -(den.*ab(:,1))./ab2 + ac(:,1) , ...
%		-(den.*ab(:,2))./ab2 + ac(:,2) , ...
%	        -(den.*ac(:,1))./ac2 + ab(:,1) , ...
%	        -(den.*ac(:,2))./ac2 + ab(:,2) ] );
	else
	g = -2*(den./nom2) ...
           * [	-(ab(:,1) + ac(:,1)) + den.*(ab(:,1)./ab2 + ac(:,1)./ac2), ...
	        -(ab(:,2) + ac(:,2)) + den.*(ab(:,2)./ab2 + ac(:,2)./ac2), ...
	        -(den.*ab(:,1))./ab2 + ac(:,1) , ...
		-(den.*ab(:,2))./ab2 + ac(:,2) , ...
	        -(den.*ac(:,1))./ac2 + ab(:,1) , ...
	        -(den.*ac(:,2))./ac2 + ab(:,2) ];
	end
end % g000

function g = g100()
end
function g = g010()
end
function g = g001(ab,ac,ab2,ac2)
	% symmetric case
	g = g010(ac,ab,ac2,ab2);
end
function g = g110()
end
function g = g101(ab,ac,ab2,ac2)
	% symmetric case
	g = g110(ac,ab,ac2,ab2);
end
function g = g011()
end
function g = g111()
end

function H = hessian_(X,Y)
cdx = 1; % 1,1
H(:,cdx) = [2./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(1./2) + (((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*(X(:,2) - 2.*X(:,1) + X(:,3)))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2) - (((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))).*(2.*(X(:,1) - X(:,2)).^2 + 2.*(X(:,1) - X(:,3)).^2 + 2.*(Y(:,1) - Y(:,2)).^2 + 2.*(Y(:,1) - Y(:,3)).^2 + 2.*(2.*X(:,1) - 2.*X(:,2)).*(2.*X(:,1) - 2.*X(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) + (3.*((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^2.*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2))];
% H(1,2)
cdx = cdx+1;
H(:,cdx) = [(((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*(X(:,1) - X(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - 1./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(1./2) + (((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))).*(2.*(X(:,1) - X(:,3)).^2 + 2.*(Y(:,1) - Y(:,3)).^2 + (2.*X(:,1) - 2.*X(:,2)).*(2.*X(:,1) - 2.*X(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*(X(:,2) - 2.*X(:,1) + X(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - (3.*(2.*X(:,1) - 2.*X(:,2)).*((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2))];
% H(1,3)
cdx = cdx+1;
H(:,cdx) = [(((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*(X(:,1) - X(:,2)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - 1./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(1./2) + (((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))).*(2.*(X(:,1) - X(:,2)).^2 + 2.*(Y(:,1) - Y(:,2)).^2 + (2.*X(:,1) - 2.*X(:,2)).*(2.*X(:,1) - 2.*X(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*(X(:,2) - 2.*X(:,1) + X(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - (3.*(2.*X(:,1) - 2.*X(:,3)).*((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2))];
% H(1,4)
cdx = cdx+1;
H(:,cdx) = [(((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*(Y(:,2) - 2.*Y(:,1) + Y(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - (((2.*X(:,1) - 2.*X(:,2)).*(2.*Y(:,1) - 2.*Y(:,3)) + (2.*X(:,1) - 2.*X(:,3)).*(2.*Y(:,1) - 2.*Y(:,2))).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) + (((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*(X(:,2) - 2.*X(:,1) + X(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) + (3.*((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2))];
% H(1,5)
cdx = cdx+1;
H(:,cdx) = [(((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*(Y(:,1) - Y(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) + ((2.*X(:,1) - 2.*X(:,3)).*(2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*(X(:,2) - 2.*X(:,1) + X(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - (3.*(2.*Y(:,1) - 2.*Y(:,2)).*((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2))];
% H(1,6)
cdx = cdx+1;
H(:,cdx) = [(((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*(Y(:,1) - Y(:,2)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) + ((2.*X(:,1) - 2.*X(:,2)).*(2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*(X(:,2) - 2.*X(:,1) + X(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - (3.*(2.*Y(:,1) - 2.*Y(:,3)).*((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2))];
% H(2,2)
cdx = cdx+1;
H(:,cdx) = [(3.*(2.*X(:,1) - 2.*X(:,2)).^2.*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).^2.*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2)) - (((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2) - ((2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*(X(:,1) - X(:,3)))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)];
% H(2,3)
cdx = cdx+1;
H(:,cdx) = [1./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(1./2) - ((2.*X(:,1) - 2.*X(:,2)).*(2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*(X(:,1) - X(:,2)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*(X(:,1) - X(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) + (3.*(2.*X(:,1) - 2.*X(:,2)).*(2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2))];
% H(2,4)
cdx = cdx+1;
H(:,cdx) = [(((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*(X(:,1) - X(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) + ((2.*X(:,1) - 2.*X(:,2)).*(2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*(Y(:,2) - 2.*Y(:,1) + Y(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - (3.*(2.*X(:,1) - 2.*X(:,2)).*((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2))];
% H(2,5)
cdx = cdx+1;
H(:,cdx) = [(3.*(2.*X(:,1) - 2.*X(:,2)).*(2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).^2.*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2)) - ((2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*(X(:,1) - X(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*(Y(:,1) - Y(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2))];
% H(2,6)
cdx = cdx+1;
H(:,cdx) = [(3.*(2.*X(:,1) - 2.*X(:,2)).*(2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2)) - ((2.*X(:,1) - 2.*X(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*(Y(:,1) - Y(:,2)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*(X(:,1) - X(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*X(:,1) - 2.*X(:,2)).*(2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2))];
% H(3,3)
cdx = cdx+1;
H(:,cdx) = [(3.*(2.*X(:,1) - 2.*X(:,3)).^2.*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).^2.*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2)) - (((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2) - ((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*(X(:,1) - X(:,2)))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)];
% H(3,4)
cdx = cdx+1;
H(:,cdx) = [(((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*(X(:,1) - X(:,2)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) + ((2.*X(:,1) - 2.*X(:,3)).*(2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*(Y(:,2) - 2.*Y(:,1) + Y(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - (3.*(2.*X(:,1) - 2.*X(:,3)).*((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2))];
% H(3,5)
cdx = cdx+1;
H(:,cdx) = [(3.*(2.*X(:,1) - 2.*X(:,3)).*(2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2)) - ((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*(Y(:,1) - Y(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*(X(:,1) - X(:,2)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*X(:,1) - 2.*X(:,3)).*(2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2))];
% H(3,6)
cdx = cdx+1;
H(:,cdx) = [(3.*(2.*X(:,1) - 2.*X(:,3)).*(2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).^2.*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2)) - ((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*(X(:,1) - X(:,2)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*X(:,1) - 2.*X(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*(Y(:,1) - Y(:,2)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2))];
% H(4,4)
cdx = cdx+1;
H(:,cdx) = [2./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(1./2) + (((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*(Y(:,2) - 2.*Y(:,1) + Y(:,3)))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2) - (((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))).*(2.*(X(:,1) - X(:,2)).^2 + 2.*(X(:,1) - X(:,3)).^2 + 2.*(Y(:,1) - Y(:,2)).^2 + 2.*(Y(:,1) - Y(:,3)).^2 + 2.*(2.*Y(:,1) - 2.*Y(:,2)).*(2.*Y(:,1) - 2.*Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) + (3.*((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^2.*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2))];
% H(4,5)
cdx = cdx+1;
H(:,cdx) = [(((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*(Y(:,1) - Y(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - 1./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(1./2) + (((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))).*(2.*(X(:,1) - X(:,3)).^2 + 2.*(Y(:,1) - Y(:,3)).^2 + (2.*Y(:,1) - 2.*Y(:,2)).*(2.*Y(:,1) - 2.*Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*(Y(:,2) - 2.*Y(:,1) + Y(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - (3.*(2.*Y(:,1) - 2.*Y(:,2)).*((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2))];
% H(4,6)
cdx = cdx+1;
H(:,cdx) = [(((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*(Y(:,1) - Y(:,2)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - 1./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(1./2) + (((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))).*(2.*(X(:,1) - X(:,2)).^2 + 2.*(Y(:,1) - Y(:,2)).^2 + (2.*Y(:,1) - 2.*Y(:,2)).*(2.*Y(:,1) - 2.*Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*(Y(:,2) - 2.*Y(:,1) + Y(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - (3.*(2.*Y(:,1) - 2.*Y(:,3)).*((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2) + (2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2))];
% H(5,5)
cdx = cdx+1;
H(:,cdx) = [(3.*(2.*Y(:,1) - 2.*Y(:,2)).^2.*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).^2.*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2)) - (((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2) - ((2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*(Y(:,1) - Y(:,3)))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)];
% H(5,6)
cdx = cdx+1;
H(:,cdx) = [1./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(1./2) - ((2.*Y(:,1) - 2.*Y(:,2)).*(2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*Y(:,1) - 2.*Y(:,2)).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*(Y(:,1) - Y(:,2)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) - ((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*(Y(:,1) - Y(:,3)))./(2.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)) + (3.*(2.*Y(:,1) - 2.*Y(:,2)).*(2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2))];
% H(6,6)
cdx = cdx+1;
H(:,cdx) = [(3.*(2.*Y(:,1) - 2.*Y(:,3)).^2.*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).^2.*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(4.*(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(5./2)) - (((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,2)).*(X(:,1) - X(:,3)) + (Y(:,1) - Y(:,2)).*(Y(:,1) - Y(:,3))))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2) - ((2.*Y(:,1) - 2.*Y(:,3)).*((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*(Y(:,1) - Y(:,2)))./(((X(:,1) - X(:,2)).^2 + (Y(:,1) - Y(:,2)).^2).*((X(:,1) - X(:,3)).^2 + (Y(:,1) - Y(:,3)).^2)).^(3./2)];
end % hessian_

function H = hessian(ab,ac,ab2,ac2)
	abac = ab.*ac;
	den  = abac(:,1) + abac(:,2);
	nom2 = ab2.*ac2;
	n = size(ab,1);

	% allocate memory
	H = zeros(6,6,n);

% first row
H(1,1,:) = (2.*(ab(:,1)+ ac(:,1)).^2)./nom2 + (4.*den)./nom2 - (2.*den.^2)./(nom2.^2) - (2.*den.^2)./(ab2.^2.*ac2) + (8.*ab(:,1).^2.*den.^2)./(ab2.^3.*ac2) + (8.*ac(:,1).^2.*den.^2)./(nom2.^3) - (8.*ab(:,1).*(ab(:,1)+ ac(:,1)).*den)./(ab2.^2.*ac2) - (8.*ac(:,1).*(ab(:,1)+ ac(:,1)).*den)./(nom2.^2) + (8.*abac(:,1).*den.^2)./(ab2.^2.*ac2.^2);
H(1,2,:) =  (2.*(ab(:,1)+ ac(:,1)).*(ab(:,2) + ac(:,2)))./nom2 - (4.*ab(:,2).*(ab(:,1)+ ac(:,1)).*den)./(ab2.^2.*ac2) - (4.*ab(:,1).*(ab(:,2) + ac(:,2)).*den)./(ab2.^2.*ac2) - (4.*ac(:,2).*(ab(:,1)+ ac(:,1)).*den)./(nom2.^2) - (4.*ac(:,1).*(ab(:,2) + ac(:,2)).*den)./(nom2.^2) + (8.*ab(:,1).*ab(:,2).*den.^2)./(ab2.^3.*ac2) + (4.*ab(:,1).*ac(:,2).*den.^2)./(ab2.^2.*ac2.^2) + (4.*ab(:,2).*ac(:,1).*den.^2)./(ab2.^2.*ac2.^2) + (8.*ac(:,1).*ac(:,2).*den.^2)./(nom2.^3);
H(1,3,:) =  (2.*den.^2)./(ab2.^2.*ac2) - (2.*den)./nom2 + (4.*ac(:,1).^2.*den)./(nom2.^2) - (2.*ac(:,1).*(ab(:,1)+ ac(:,1)))./nom2 - (8.*ab(:,1).^2.*den.^2)./(ab2.^3.*ac2) + (4.*ab(:,1).*(ab(:,1)+ ac(:,1)).*den)./(ab2.^2.*ac2) + (4.*abac(:,1).*den)./(ab2.^2.*ac2) - (4.*abac(:,1).*den.^2)./(ab2.^2.*ac2.^2);
H(1,4,:) =  (4.*ab(:,2).*(ab(:,1)+ ac(:,1)).*den)./(ab2.^2.*ac2) - (2.*ac(:,2).*(ab(:,1)+ ac(:,1)))./nom2 + (4.*ab(:,1).*ac(:,2).*den)./(ab2.^2.*ac2) + (4.*ac(:,1).*ac(:,2).*den)./(nom2.^2) - (8.*ab(:,1).*ab(:,2).*den.^2)./(ab2.^3.*ac2) - (4.*ab(:,2).*ac(:,1).*den.^2)./(ab2.^2.*ac2.^2);
H(1,5,:) =  (2.*den.^2)./(nom2.^2) - (2.*den)./nom2 + (4.*ab(:,1).^2.*den)./(ab2.^2.*ac2) - (2.*ab(:,1).*(ab(:,1)+ ac(:,1)))./nom2 - (8.*ac(:,1).^2.*den.^2)./(nom2.^3) + (4.*ac(:,1).*(ab(:,1)+ ac(:,1)).*den)./(nom2.^2) + (4.*abac(:,1).*den)./(nom2.^2) - (4.*abac(:,1).*den.^2)./(ab2.^2.*ac2.^2);
H(1,6,:) =  (4.*ac(:,2).*(ab(:,1)+ ac(:,1)).*den)./(nom2.^2) - (2.*ab(:,2).*(ab(:,1)+ ac(:,1)))./nom2 + (4.*ab(:,1).*ab(:,2).*den)./(ab2.^2.*ac2) + (4.*ab(:,2).*ac(:,1).*den)./(nom2.^2) - (4.*ab(:,1).*ac(:,2).*den.^2)./(ab2.^2.*ac2.^2) - (8.*ac(:,1).*ac(:,2).*den.^2)./(nom2.^3);

% second row
H(2,1,:) =  H(1,2,:);
H(2,2,:) =  (2.*(ab(:,2) + ac(:,2)).^2)./nom2 + (4.*den)./nom2 - (2.*den.^2)./(nom2.^2) - (2.*den.^2)./(ab2.^2.*ac2) + (8.*ab(:,2).^2.*den.^2)./(ab2.^3.*ac2) + (8.*ac(:,2).^2.*den.^2)./(nom2.^3) - (8.*ab(:,2).*(ab(:,2) + ac(:,2)).*den)./(ab2.^2.*ac2) - (8.*ac(:,2).*(ab(:,2) + ac(:,2)).*den)./(nom2.^2) + (8.*abac(:,2).*den.^2)./(ab2.^2.*ac2.^2);
H(2,3,:) =  (4.*ab(:,1).*(ab(:,2) + ac(:,2)).*den)./(ab2.^2.*ac2) - (2.*ac(:,1).*(ab(:,2) + ac(:,2)))./nom2 + (4.*ab(:,2).*ac(:,1).*den)./(ab2.^2.*ac2) + (4.*ac(:,1).*ac(:,2).*den)./(nom2.^2) - (8.*ab(:,1).*ab(:,2).*den.^2)./(ab2.^3.*ac2) - (4.*ab(:,1).*ac(:,2).*den.^2)./(ab2.^2.*ac2.^2);
H(2,4,:) =  (2.*den.^2)./(ab2.^2.*ac2) - (2.*den)./nom2 + (4.*ac(:,2).^2.*den)./(nom2.^2) - (2.*ac(:,2).*(ab(:,2) + ac(:,2)))./nom2 - (8.*ab(:,2).^2.*den.^2)./(ab2.^3.*ac2) + (4.*ab(:,2).*(ab(:,2) + ac(:,2)).*den)./(ab2.^2.*ac2) + (4.*abac(:,2).*den)./(ab2.^2.*ac2) - (4.*abac(:,2).*den.^2)./(ab2.^2.*ac2.^2);
H(2,5,:) =  (4.*ac(:,1).*(ab(:,2) + ac(:,2)).*den)./(nom2.^2) - (2.*ab(:,1).*(ab(:,2) + ac(:,2)))./nom2 + (4.*ab(:,1).*ab(:,2).*den)./(ab2.^2.*ac2) + (4.*ab(:,1).*ac(:,2).*den)./(nom2.^2) - (4.*ab(:,2).*ac(:,1).*den.^2)./(ab2.^2.*ac2.^2) - (8.*ac(:,1).*ac(:,2).*den.^2)./(nom2.^3);
H(2,6,:) =  (2.*den.^2)./(nom2.^2) - (2.*den)./nom2 + (4.*ab(:,2).^2.*den)./(ab2.^2.*ac2) - (2.*ab(:,2).*(ab(:,2) + ac(:,2)))./nom2 - (8.*ac(:,2).^2.*den.^2)./(nom2.^3) + (4.*ac(:,2).*(ab(:,2) + ac(:,2)).*den)./(nom2.^2) + (4.*abac(:,2).*den)./(nom2.^2) - (4.*abac(:,2).*den.^2)./(ab2.^2.*ac2.^2);

% third row
H(3,1,:) =  H(1,3,:);
H(3,2,:) =  H(2,3,:);
H(3,3,:) =  (2.*ac(:,1).^2)./nom2 - (2.*den.^2)./(ab2.^2.*ac2) + (8.*ab(:,1).^2.*den.^2)./(ab2.^3.*ac2) - (8.*abac(:,1).*den)./(ab2.^2.*ac2);
H(3,4,:) =  (2.*ac(:,1).*ac(:,2))./nom2 - (4.*ab(:,1).*ac(:,2).*den)./(ab2.^2.*ac2) - (4.*ab(:,2).*ac(:,1).*den)./(ab2.^2.*ac2) + (8.*ab(:,1).*ab(:,2).*den.^2)./(ab2.^3.*ac2);
H(3,5,:) =  (2.*den)./nom2 - (4.*ab(:,1).^2.*den)./(ab2.^2.*ac2) - (4.*ac(:,1).^2.*den)./(nom2.^2) + (2.*abac(:,1))./nom2 + (4.*abac(:,1).*den.^2)./(ab2.^2.*ac2.^2);
H(3,6,:) =  (2.*ab(:,2).*ac(:,1))./nom2 - (4.*ab(:,1).*ab(:,2).*den)./(ab2.^2.*ac2) - (4.*ac(:,1).*ac(:,2).*den)./(nom2.^2) + (4.*ab(:,1).*ac(:,2).*den.^2)./(ab2.^2.*ac2.^2);

% fourth row
H(4,1,:) =  H(1,4,:);
H(4,2,:) =  H(2,4,:);
H(4,3,:) =  H(3,4,:);
H(4,4,:) =  (2.*ac(:,2).^2)./nom2 - (2.*den.^2)./(ab2.^2.*ac2) + (8.*ab(:,2).^2.*den.^2)./(ab2.^3.*ac2) - (8.*abac(:,2).*den)./(ab2.^2.*ac2);
H(4,5,:) =  (2.*ab(:,1).*ac(:,2))./nom2 - (4.*ab(:,1).*ab(:,2).*den)./(ab2.^2.*ac2) - (4.*ac(:,1).*ac(:,2).*den)./(nom2.^2) + (4.*ab(:,2).*ac(:,1).*den.^2)./(ab2.^2.*ac2.^2);
H(4,6,:) =  (2.*den)./nom2 - (4.*ab(:,2).^2.*den)./(ab2.^2.*ac2) - (4.*ac(:,2).^2.*den)./(nom2.^2) + (2.*abac(:,2))./nom2 + (4.*abac(:,2).*den.^2)./(ab2.^2.*ac2.^2);
% fifth row
H(5,1,:) =  H(1,5,:);
H(5,2,:) =  H(2,5,:);
H(5,3,:) =  H(3,5,:);
H(5,4,:) =  H(4,5,:);
H(5,5,:) =  (2.*ab(:,1).^2)./nom2 - (2.*den.^2)./(nom2.^2) + (8.*ac(:,1).^2.*den.^2)./(nom2.^3) - (8.*abac(:,1).*den)./(nom2.^2);
H(5,6,:) =  (2.*ab(:,1).*ab(:,2))./nom2 - (4.*ab(:,1).*ac(:,2).*den)./(nom2.^2) - (4.*ab(:,2).*ac(:,1).*den)./(nom2.^2) + (8.*ac(:,1).*ac(:,2).*den.^2)./(nom2.^3);
% sixth row
H(6,1,:) =  H(1,6,:);
H(6,2,:) =  H(2,6,:);
H(6,3,:) =  H(3,6,:);
H(6,4,:) =  H(4,6,:);
H(6,5,:) =  H(5,6,:);
H(6,6,:) =  (2.*ab(:,2).^2)./nom2 - (2.*den.^2)./(nom2.^2) + (8.*ac(:,2).^2.*den.^2)./(nom2.^3) - (8.*abac(:,2).*den)./(nom2.^2);

end % hessian


